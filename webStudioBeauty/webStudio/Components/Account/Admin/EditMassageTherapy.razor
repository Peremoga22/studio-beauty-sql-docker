@page "/edit-massage-therapy"
@page "/edit-massage-therapy/{Id:int}"

@* @inject IWebHostEnvironment Env *@
@inject NavigationManager _navigationManager
@inject MassageService _massageService
@inject IJSRuntime _jSRuntime
@layout AdminLayout
@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer

<div class="container py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="breadcrumb-card mb-4">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item">
                <a class="link-accent" href="/admin-massage-therapy">
                    <i class="bi bi-arrow-left-short"></i> Повернутися до адмін сторінка масажна терапія
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                @AddMessageTherapy
            </li>
        </ol>
    </nav>

    <div class="row g-3 mb-4">
        <!-- Форма титулки сторінки -->
        <div class="col-12 col-lg-12">
            <EditForm Model="@modelTitle"                    
                      OnSubmit="HandleValidSubmit"
                      FormName="CosmetologyTherapy"
                      class="card form-card">
                 <DataAnnotationsValidator />              
                <div class="card-body">
                    <h5 class="card-title text-center mb-3">
                        Назва титулки сторінки"
                    </h5>

                    <div class="mb-3">
                        <label for="InputTitlePage" class="form-label form-label-compact">
                            Назва сторінки <span class="text-danger">*</span><strong style="color:red">@ErrorTiteleOrDescription</strong>
                        </label>
                        <InputText id="InputTitlePage"
                                   @bind-Value="modelTitle.TitlePage"
                                   class="form-control form-control-sm"
                                   placeholder="Введіть назву..." />                       
                    </div>

                    <div class="mb-0">
                        <label for="InputDescription" class="form-label form-label-compact">
                            Опис сторінки <span class="text-danger">*</span><strong style="color:red">@ErrorTiteleOrDescription</strong>
                        </label>
                        <InputText id="InputDescription"
                                   @bind-Value="modelTitle.Description"
                                   class="form-control form-control-sm"
                                   placeholder="Короткий опис..." />                       
                    </div>
                </div>

                <div class="card-footer d-flex justify-content-end gap-2">
                    <button type="submit" class="btn btn-primary btn-sm px-3">
                        <i class="bi bi-save"></i> <span class="d-none d-sm-inline">Зберегти</span>
                    </button>
                    <NavLink class="btn btn-outline-secondary btn-sm px-3" href="/admin-massage-therapy">
                        <i class="bi bi-x-circle"></i> <span class="d-none d-sm-inline">Скасувати</span>
                    </NavLink>
                </div>
            </EditForm>
        </div>


    </div>
    <header class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
        <NavLink class="btn btn-success btn-sm px-3 d-flex align-items-center"
                 href="/edit-massage-therapy-card">
            <i class="bi bi-collection me-1"></i><span class="d-none d-sm-inline">Додати картку</span>
        </NavLink>
    </header>

    <!-- Сітка карток послуг -->
    <section>
        <h5 class="section-title mb-2">Картки послуг</h5>
        <figure class="figure m-0">
            <div class="row g-3">
                @foreach (var item in messageTherapyCards)
                {
                    <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
                        <div class="card service-card h-100">
                            <!-- Відео / прев’ю -->
                            <div class="ratio ratio-16x9">
                                <!-- Якщо item.ImageUrl містить YouTube videoId -->
                                <lite-youtube class="w-100 h-100"
                                              videoid="@item.ImageUrl"
                                              title="@item.TitleCard">
                                </lite-youtube>
                            </div>

                            <div class="card-body d-flex flex-column p-3">
                                <h6 class="card-title mb-1 text-truncate" title="@item.TitleCard">
                                    @item.TitleCard
                                </h6>

                                <p class="card-text text-muted small mb-3 line-clamp-2"
                                   title="@item.DescriptionCard">
                                    @item.DescriptionCard
                                </p>

                                <div class="mt-auto d-flex flex-column flex-sm-row justify-content-between align-items-stretch gap-2">
                                    <button @onclick="(() => EditAdmin(item.Id))"
                                            class="btn btn-outline-primary btn-sm flex-grow-1">
                                        <i class="bi bi-pencil-square me-1"></i>
                                        <span class="d-none d-sm-inline">Редагувати</span>
                                    </button>

                                    <span class="price-chip text-nowrap">
                                        <i class="bi bi-cash-stack me-1"></i>
                                        @item.Price.ToString("C0", new System.Globalization.CultureInfo("uk-UA"))
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </figure>
    </section>

</div>

@code {
    [Parameter]
    public int Id { get; set; }
    private string AddMessageTherapy = "Додати категорію";
    private MassageTherapy modelTitle = new();
    private List<MassageTherapyCard> messageTherapyCards = new();
    private string ErrorTiteleOrDescription = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        modelTitle = await _massageService.EditMassageTherapyFirstOrDefaultAsync();
        messageTherapyCards = await _massageService.GetAllMassageTherapyCardListAsync();
        this.StateHasChanged();
    }

    private void HandleValidSubmit()
    {
        if (string.IsNullOrWhiteSpace(modelTitle.TitlePage) && string.IsNullOrWhiteSpace(modelTitle.Description))
        {
            ErrorTiteleOrDescription = "Поле не може бути порожнім";
            return;
        }

        _massageService.SaveTitle(modelTitle);
        _navigationManager.NavigateTo("/admin-massage-therapy");
    }

    protected void EditAdmin(int id)
    {
        _navigationManager.NavigateTo($"/edit-massage-therapy-card/{id}");
    }
}
